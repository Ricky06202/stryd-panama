---
import AdminLayout from '../../layouts/AdminLayout.astro'
import { getDb } from '../../db/client'
import { users, membershipRequests } from '../../db/schema'
import { eq, desc } from 'drizzle-orm'

const runtime = Astro.locals.runtime;
const db = getDb(runtime.env.DB);

// Obtener solicitudes pendientes
const requestsRaw = await db
  .select({
    id: membershipRequests.id,
    status: membershipRequests.status,
    isAlreadyMember: membershipRequests.isAlreadyMember,
    createdAt: membershipRequests.createdAt,
    user: {
      fullName: users.fullName,
      email: users.email,
      idCard: users.idCard,
      phone: users.phone,
    }
  })
  .from(membershipRequests)
  .innerJoin(users, eq(membershipRequests.userId, users.id))
  .where(eq(membershipRequests.status, 'pending'))
  .orderBy(desc(membershipRequests.createdAt))
  .all()

// Sanitizar datos para evitar DevalueError
const requests = requestsRaw.map(req => ({
  ...req,
  createdAt: req.createdAt ? new Date(req.createdAt).toLocaleDateString('es-PA') : 'N/A'
}))
---

<AdminLayout title="Solicitudes de Registro">
  <div class="mb-8 flex justify-between items-center">
    <div>
      <h1 class="text-3xl font-bold text-foreground">Solicitudes de Registro</h1>
      <p class="text-muted-foreground mt-2">
        Revisa y gestiona las nuevas solicitudes para unirse al equipo.
      </p>
    </div>
  </div>

  <div class="bg-card rounded-xl border border-border overflow-hidden">
    <div class="overflow-x-auto">
      <table class="w-full text-left border-collapse">
        <thead>
          <tr class="bg-muted/50 border-b border-border">
            <th class="px-6 py-4 text-sm font-semibold text-foreground uppercase tracking-wider">Atleta</th>
            <th class="px-6 py-4 text-sm font-semibold text-foreground uppercase tracking-wider">Cédula / ID</th>
            <th class="px-6 py-4 text-sm font-semibold text-foreground uppercase tracking-wider">Contacto</th>
            <th class="px-6 py-4 text-sm font-semibold text-foreground uppercase tracking-wider">Fecha</th>
            <th class="px-6 py-4 text-sm font-semibold text-foreground uppercase tracking-wider text-right">Acciones</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-border">
          {requests.length === 0 ? (
            <tr>
              <td colspan="5" class="px-6 py-8 text-center text-muted-foreground">
                No hay solicitudes pendientes en este momento.
              </td>
            </tr>
          ) : (
            requests.map((req) => (
              <tr class="hover:bg-muted/30 transition-colors group">
                <td class="px-6 py-4">
                  <div class="font-bold text-foreground flex items-center gap-2">
                    {req.user.fullName}
                    {req.isAlreadyMember && (
                      <span class="px-2 py-0.5 bg-blue-100 text-blue-700 text-[10px] font-bold rounded-full uppercase">
                        Ya es Miembro
                      </span>
                    )}
                  </div>
                  <div class="text-sm text-muted-foreground">{req.user.email}</div>
                </td>
                <td class="px-6 py-4 text-sm text-foreground">
                  {req.user.idCard}
                </td>
                <td class="px-6 py-4 text-sm text-foreground">
                  {req.user.phone || 'N/A'}
                </td>
                <td class="px-6 py-4 text-sm text-muted-foreground">
                  {req.createdAt}
                </td>
                <td class="px-6 py-4 text-right">
                  <div class="flex justify-end gap-2">
                    <a
                      href={`/admin/requests/${req.id}`}
                      class="px-3 py-1.5 bg-muted hover:bg-muted/80 text-foreground text-xs font-bold rounded-lg transition border border-border"
                    >
                      Ver Detalle
                    </a>
                    <button
                      onclick={`handleAction(${req.id}, 'approve')`}
                      class="px-3 py-1.5 bg-green-600 hover:bg-green-700 text-white text-xs font-bold rounded-lg transition shadow-sm"
                    >
                      Aprobar
                    </button>
                    <button
                      onclick={`handleAction(${req.id}, 'reject')`}
                      class="px-3 py-1.5 bg-red-600/10 hover:bg-red-600/20 text-red-500 text-xs font-bold rounded-lg transition border border-red-500/20"
                    >
                      Rechazar
                    </button>
                  </div>
                </td>
              </tr>
            ))
          )}
        </tbody>
      </table>
    </div>
  </div>
</AdminLayout>

<script is:inline>
  async function handleAction(requestId, action) {
    if (!confirm(`¿Estás seguro de que deseas ${action === 'approve' ? 'aprobar' : 'rechazar'} esta solicitud?`)) {
      return;
    }

    try {
      const response = await fetch('/api/admin/requests', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ requestId, action }),
      });

      if (response.ok) {
        window.location.reload();
      } else {
        const data = await response.json();
        alert('Error: ' + data.error);
      }
    } catch (error) {
      alert('Error de conexión al procesar la solicitud');
    }
  }
</script>
